{% extends "core/base.html" %}

{% block title %}Courses Dashboard{% endblock %}

{% block content %}
<div class="container">

    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h3 class="fw-bold mb-0">Courses Dashboard</h3>
            <small class="text-muted">
                Manage and create courses
            </small>
        </div>

        <a href="{% url 'courses:create_course' %}" class="btn text-light" style="background-color: #7b1020;">
            + Create Course
        </a>
    </div>

    <!-- Courses Table Section -->
    <div>
        <!-- Courses Header + Filters -->
        <div class="d-flex justify-content-between align-items-center mb-3">

            <!-- Title -->
            <h5 class="fw-semibold mb-0">All Courses ({{ total_courses }})</h5>

            <!-- Filters -->
            <form method="get" class="d-flex gap-2">
                <!-- Status Filter -->
                <select name="status" class="form-select form-select-sm">
                    <option value="">All Status</option>
                    <option value="published" {% if request.GET.status == "published" %}selected{% endif %}>
                        Published
                    </option>
                    <option value="draft" {% if request.GET.status == "draft" %}selected{% endif %}>
                        Draft
                    </option>
                </select>

                <!-- Submit -->
                <button type="submit" class="btn btn-sm btn-outline-dark">
                    Filter
                </button>
            </form>

        </div>


        <div class="card border-0 shadow-sm">
            <table class="table mb-0">
                <thead class="table-light">
                    <tr>
                        <th>Course Title</th>
                        <th>Category</th>
                        <th>Duration</th>
                        <th>Created By</th>
                        <th>Created At</th>
                        <th>Status</th>
                        <th class="text-end">Action</th>
                    </tr>
                </thead>
                <tbody>
                    {% for course in courses %}
                    <tr>
                        <td>
                            <div class="d-flex align-items-center">
                                {% if course.thumbnail %}
                                <img src="{{ course.thumbnail.url }}" alt="{{ course.title }}" 
                                     class="rounded me-2" width="40" height="40">
                                {% endif %}
                                <strong>{{ course.title }}</strong>
                            </div>
                        </td>
                        <td>
                            {% if course.category %}
                                <span class="badge bg-light text-dark">{{ course.category.name }}</span>
                            {% else %}
                                <span class="text-muted">—</span>
                            {% endif %}
                        </td>
                        <td>{{ course.video_duration_minutes }} min</td>
                        <td>{{ course.created_by.username|default:"System" }}</td>
                        <td>{{ course.created_at|date:"Y-m-d" }}</td>
                        <td>
                            {% if not course.is_published %}
                                <span class="badge bg-secondary">Draft</span>

                            {% elif course.is_published and not course.is_active %}
                                <span class="badge bg-warning text-dark">Deactivated</span>

                            {% else %}
                                <span class="badge bg-success">Published</span>
                            {% endif %}
                            
                        </td>
                        <td class="text-end">
                            <div class="dropdown">
                                <button class="btn btn-sm btn-light"
                                        data-bs-toggle="dropdown"
                                        aria-expanded="false">
                                    ⋮
                                </button>
                        
                                <ul class="dropdown-menu dropdown-menu-end">
                        
                                    <!-- Draft → Edit -->
                                    {% if not course.is_published %}
                                    <li>
                                        <a class="dropdown-item"
                                           href="{% url 'courses:edit_course' course.id %}">
                                            Edit
                                        </a>
                                    </li>
                                    {% endif %}
                        
                                    <!-- Published → Deactivate -->
                                    {% if course.is_published and course.is_active %}
                                    <!-- Edit -->
                                    <li>
                                        <a class="dropdown-item"
                                        href="{% url 'courses:edit_course' course.id %}">
                                        Edit
                                        </a>
                                    </li>
                                    <li>
                                        <a class="dropdown-item"
                                           href="#"
                                           data-bs-toggle="modal"
                                           data-bs-target="#viewCompaniesModal"
                                           data-course-id="{{ course.id }}"
                                           data-course-title="{{ course.title }}">
                                          View Companies
                                        </a>
                                    </li>
                                    <li>
                                        <a class="dropdown-item text-danger"
                                           href="{% url 'courses:deactivate_course' course.id %}">
                                            Deactivate
                                        </a>
                                    </li>
                                    {% endif %}
                        
                                    <!-- Deactivated → Activate -->
                                    {% if not course.is_active %}
                                    <li>
                                        <a class="dropdown-item text-success"
                                           href="{% url 'courses:activate_course' course.id %}">
                                            Activate
                                        </a>
                                    </li>
                                    {% endif %}
                        
                                </ul>
                            </div>
                        </td>    
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="7" class="text-center text-muted">
                            No courses found
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>

        </div>
        
    </div>

    <div class="modal fade" id="viewCompaniesModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title">Published Companies</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
      
            <div class="modal-body">
              <!-- <h6 id="modalCourseTitle" class="mb-3"></h6> -->
              <p class="text-muted mb-2 small" id="companiesCount"></p>
              <ul id="companiesList" class="list-group list-group-flush">
                <li class="list-group-item text-muted">Loading...</li>
              </ul>
            </div>
          </div>
        </div>
      </div>
      

</div>

<script>
    document.addEventListener("DOMContentLoaded", function () {

        const modal = document.getElementById("viewCompaniesModal");

        modal.addEventListener("show.bs.modal", function (event) {

        const button = event.relatedTarget;
        if (!button) return;

        const courseId = button.getAttribute("data-course-id");

        const countEl = document.getElementById("companiesCount");
        const listEl  = document.getElementById("companiesList");

        // reset
        countEl.textContent = "";
        listEl.innerHTML = `<li class="list-group-item text-muted">Loading...</li>`;

        fetch(`/courses/platform-admin/courses/${courseId}/companies/`)
            .then(res => res.json())
            .then(data => {

            listEl.innerHTML = "";
            countEl.textContent = `${data.companies.length} Companies`;

            if (data.companies.length === 0) {
                listEl.innerHTML = `
                <li class="list-group-item text-muted">
                    No companies assigned
                </li>`;
            } else {
                data.companies.forEach(name => {
                listEl.innerHTML += `
                    <li class="list-group-item">${name}</li>`;
                });
            }
            })
            .catch(() => {
            listEl.innerHTML = `
                <li class="list-group-item text-danger">
                Failed to load companies
                </li>`;
            });

        });

        });

</script>
    
    
{% endblock %}

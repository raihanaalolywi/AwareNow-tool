{% extends "core/base.html" %}
{% load static %}

{% block title %}Quiz Results - {{ quiz.course.title }}{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/course_learning.css' %}">
{% endblock %}

{% block content %}
<div class="container-fluid px-0">

  <!-- ===== Quiz Header (SAME AS QUESTIONS PAGE) ===== -->
  <div class="quiz-header">
    <div class="container">
      <div class="quiz-header-row">

        <!-- Left -->
        <div class="quiz-left">
          <a href="{% url 'account:view_course' quiz.course.id %}" class="course-back">
            <span class="material-symbols-outlined">arrow_back</span>
          </a>

          <div>
            <h1 class="quiz-title">Quiz Results</h1>

            <div class="quiz-meta">
              <span>üìù {{ quiz.questions.count }} Questions</span>
              <span>üéØ Pass: {{ quiz.passing_score }}%</span>
              <span>üîÅ Attempt {{ attempt.attempt_number }}/{{ quiz.max_attempts }}</span>
            </div>
          </div>
        </div>

        <!-- Right: Status -->
        <div class="quiz-timer">
          {% if attempt.passed %}
            <span class="text-success fw-bold">PASSED</span>
          {% else %}
            <span class="text-danger fw-bold">FAILED</span>
          {% endif %}
        </div>

      </div>
    </div>
  </div>

  <!-- ===== Content ===== -->
  <div class="container py-4">
    <div class="row justify-content-center">
      <div class="col-lg-8">

        <!-- ===== Score Card ===== -->
        <div class="card border-grey mb-4">
          <div class="card-body text-center py-5">

            <div class="display-3 fw-bold {% if attempt.passed %}text-success{% else %}text-danger{% endif %}">
              {{ attempt.score|floatformat:1 }}%
            </div>

            <p class="mt-3 text-muted">
              Completed in {{ time_taken_minutes }}m {{ time_taken_seconds }}s
            </p>

          </div>
        </div>

        <!-- ===== Question Review ===== -->
        {% for result in results %}
        <div class="card border-grey mb-4">

          <!-- Question Header -->
          <div class="card-header bg-grey">
            <div class="d-flex justify-content-between align-items-start">
              <p class="mb-0 fw-semibold">
                {{ result.question.question_text }}
              </p>

              <span class="badge bg-secondary small fw-normal ms-3">
                {% if result.is_correct %}
                  +{{ result.points }} pts
                {% else %}
                  0 pts
                {% endif %}
              </span>
            </div>
          </div>

          <!-- Answers -->
          <div class="card-body">
            {% if result.options %}
              {% for option in result.options %}
                <div class="form-check mb-2">

                  {% if option.label in result.correct_answers %}
                    <span class="text-success fw-bold">‚úî</span>
                  {% elif option.label in result.user_answer %}
                    <span class="text-danger fw-bold">‚úñ</span>
                  {% else %}
                    <span class="text-muted">‚Ä¢</span>
                  {% endif %}

                  <span class="ms-2">
                    {{ option.text }}
                  </span>
                </div>
              {% endfor %}
            {% endif %}

            {% if result.question.explanation %}
            <div class="question-explanation">
                <!-- <span class="exp-label">Explanation</span> -->
                <p>{{ result.question.explanation }}</p>
            </div>              
            {% endif %}
          </div>

        </div>
        {% endfor %}

        <!-- ===== Actions ===== -->
        <div class="text-center mt-5">

          {% if not attempt.passed and attempt.attempt_number < quiz.max_attempts %}
            <a href="{% url 'account:start_quiz' quiz.course.id %}"
               class="btn btn-brand px-5 py-2 fw-semibold">
              Try Again
            </a>
          {% endif %}

          {% if attempt.passed %}
            <a href="{% url 'account:view_course' quiz.course.id %}"
               class="btn btn-brand px-5 py-2 fw-semibold">
              Back to Course
            </a>
          {% endif %}

        </div>

      </div>
    </div>
  </div>
</div>
{% endblock %}

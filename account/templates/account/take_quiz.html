


{% extends "core/base.html" %}
{% load static %}

{% block title %}Quiz: {{ quiz.course.title }}{% endblock %}

{% block content %}
<div class="container-fluid px-0">
    <!-- Quiz Header -->
    <div class="bg-dark text-white py-3">
        <div class="container">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1 class="h4 mb-0 fw-normal">{{ quiz.title }}</h1>
                    <div class="d-flex align-items-center mt-1">
                        <span class="badge bg-secondary me-2">
                            Attempt {{ attempt_number }} of {{ quiz.max_attempts }}
                        </span>
                        {% if quiz.time_limit_minutes > 0 %}
                        <span class="badge bg-warning text-dark me-2">
                            <i class="fas fa-clock me-1"></i>{{ quiz.time_limit_minutes }} min
                        </span>
                        {% endif %}
                        <small class="text-white-50">
                            Required to pass: {{ quiz.passing_score }}%
                        </small>
                    </div>
                </div>
                <div>
                    <a href="{% url 'account:view_course' quiz.course.id %}" class="btn btn-outline-light btn-sm">
                        <i class="fas fa-arrow-left me-1"></i>Back to Course
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Quiz Content -->
    <div class="container py-4">
        <div class="row justify-content-center">
            <div class="col-lg-8">
                <!-- Quiz Instructions -->
                <div class="card border-dark mb-4">
                    <div class="card-header bg-dark text-white">
                        <h5 class="mb-0">
                            <i class="fas fa-question-circle me-2"></i>
                            Quiz Instructions
                        </h5>
                    </div>
                    <div class="card-body">
                        {% if quiz.description %}
                            <p>{{ quiz.description }}</p>
                        {% endif %}
                        
                        <div class="row">
                            <div class="col-md-6">
                                <ul class="list-unstyled">
                                    <li class="mb-2">
                                        <i class="fas fa-check-circle text-success me-2"></i>
                                        {{ quiz.questions.count }} questions
                                    </li>
                                    <li class="mb-2">
                                        <i class="fas fa-percentage text-primary me-2"></i>
                                        Pass mark: {{ quiz.passing_score }}%
                                    </li>
                                </ul>
                            </div>
                            <div class="col-md-6">
                                <ul class="list-unstyled">
                                    <li class="mb-2">
                                        <i class="fas fa-redo text-warning me-2"></i>
                                        Attempts: {{ attempt_number }}/{{ quiz.max_attempts }}
                                    </li>
                                    {% if quiz.time_limit_minutes > 0 %}
                                    <li class="mb-2">
                                        <i class="fas fa-clock text-danger me-2"></i>
                                        Time limit: {{ quiz.time_limit_minutes }} minutes
                                    </li>
                                    {% endif %}
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Quiz Questions Form -->
                <form method="post" action="{% url 'account:submit_quiz' attempt.id %}" id="quizForm">
                    {% csrf_token %}
                    
                    {% for question in questions %}
                    <div class="card border-grey mb-4 question-card" data-question-type="{{ question.question_type }}">
                        <div class="card-header bg-grey">
                            <h5 class="mb-0 d-flex justify-content-between align-items-center">
                                <span>Question {{ forloop.counter }}</span>
                                <span class="badge bg-dark">{{ question.points }} points</span>
                            </h5>
                        </div>
                        <div class="card-body">
                            <p class="fw-medium mb-3">{{ question.question_text }}</p>
                            
                            {% if question.question_type == 'multiple_choice' %}
                                <!-- Multiple Choice (Single Answer) -->
                                <div class="form-group">
                                    {% for option_label, option_value in question.options %}
                                    <div class="form-check mb-2">
                                        <input class="form-check-input" type="radio" 
                                               name="question_{{ question.id }}" 
                                               id="q{{ question.id }}_option{{ option_label }}"
                                               value="{{ option_label }}"
                                               required>
                                        <label class="form-check-label" for="q{{ question.id }}_option{{ option_label }}">
                                            {{ option_value }}
                                        </label>
                                    </div>
                                    {% endfor %}
                                </div>
                                
                            {% elif question.question_type == 'multiple_select' %}
                                <!-- Multiple Select -->
                                <div class="form-group">
                                    {% for option_label, option_value in question.options %}
                                    <div class="form-check mb-2">
                                        <input class="form-check-input" type="checkbox"
                                               name="question_{{ question.id }}" 
                                               id="q{{ question.id }}_option{{ option_label }}"
                                               value="{{ option_label }}">
                                        <label class="form-check-label" for="q{{ question.id }}_option{{ option_label }}">
                                            {{ option_value }}
                                        </label>
                                    </div>
                                    {% endfor %}
                                </div>
                                
                            {% elif question.question_type == 'true_false' %}
                                <!-- True/False -->
                                <div class="form-group">
                                    <div class="form-check mb-2">
                                        <input class="form-check-input" type="radio" 
                                               name="question_{{ question.id }}" 
                                               id="q{{ question.id }}_true"
                                               value="True"
                                               required>
                                        <label class="form-check-label" for="q{{ question.id }}_true">
                                            True
                                        </label>
                                    </div>
                                    <div class="form-check mb-2">
                                        <input class="form-check-input" type="radio" 
                                               name="question_{{ question.id }}" 
                                               id="q{{ question.id }}_false"
                                               value="False">
                                        <label class="form-check-label" for="q{{ question.id }}_false">
                                            False
                                        </label>
                                    </div>
                                </div>
                            {% endif %}
                        </div>
                    </div>
                    {% endfor %}
                    
                    <!-- Quiz Actions -->
                    <div class="d-flex justify-content-between align-items-center p-4 bg-grey rounded">
                        <div>
                            <button type="button" class="btn btn-outline-dark" id="saveDraftBtn">
                                <i class="fas fa-save me-2"></i>Save Draft
                            </button>
                        </div>
                        <div>
                            <button type="submit" class="btn btn-success px-4">
                                <i class="fas fa-paper-plane me-2"></i>Submit Quiz
                            </button>
                        </div>
                    </div>
                </form>
                
                <!-- Timer Display (if time limit) -->
                {% if quiz.time_limit_minutes > 0 %}
                <div class="mt-3 text-center">
                    <div class="alert alert-warning">
                        <i class="fas fa-clock me-2"></i>
                        Time remaining: <span id="timerDisplay">{{ quiz.time_limit_minutes }}:00</span>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- JavaScript placed inline -->
<script>
// Quiz timer
{% if quiz.time_limit_minutes > 0 %}
let timeLimitMinutes = {{ quiz.time_limit_minutes }};
let totalSeconds = timeLimitMinutes * 60;
let timerInterval;

function updateTimer() {
    totalSeconds--;
    
    if (totalSeconds <= 0) {
        clearInterval(timerInterval);
        document.getElementById('timerDisplay').textContent = "Time's up!";
        
        // Auto-submit the form
        setTimeout(() => {
            document.getElementById('quizForm').submit();
        }, 1000);
        return;
    }
    
    const minutes = Math.floor(totalSeconds / 60);
    const seconds = totalSeconds % 60;
    document.getElementById('timerDisplay').textContent = 
        `${minutes}:${seconds.toString().padStart(2, '0')}`;
}

// Start timer
timerInterval = setInterval(updateTimer, 1000);
{% endif %}

// Save draft functionality
document.getElementById('saveDraftBtn').addEventListener('click', function() {
    const formData = new FormData(document.getElementById('quizForm'));
    const answers = {};
    
    // Collect all answers
    document.querySelectorAll('.question-card').forEach(card => {
        const questionId = card.querySelector('input')?.name?.replace('question_', '');
        if (!questionId) return;
        
        const questionType = card.dataset.questionType;
        const inputs = card.querySelectorAll('input:checked');
        
        if (questionType === 'multiple_select') {
            answers[questionId] = Array.from(inputs).map(input => input.value).join(',');
        } else if (inputs.length > 0) {
            answers[questionId] = inputs[0].value;
        }
    });
    
    // Save to localStorage
    localStorage.setItem('quiz_draft_{{ quiz.id }}', JSON.stringify(answers));
    
    // Show feedback
    const originalText = this.innerHTML;
    this.innerHTML = '<i class="fas fa-check me-2"></i>Draft Saved!';
    this.classList.remove('btn-outline-dark');
    this.classList.add('btn-success');
    
    setTimeout(() => {
        this.innerHTML = originalText;
        this.classList.remove('btn-success');
        this.classList.add('btn-outline-dark');
    }, 2000);
});

// Load draft on page load
document.addEventListener('DOMContentLoaded', function() {
    const savedDraft = localStorage.getItem('quiz_draft_{{ quiz.id }}');
    if (savedDraft) {
        const answers = JSON.parse(savedDraft);
        
        Object.keys(answers).forEach(questionId => {
            const answer = answers[questionId];
            const card = document.querySelector(`[data-question-type] input[name="question_${questionId}"]`)?.closest('.question-card');
            if (!card) return;
            
            const questionType = card.dataset.questionType;
            
            if (questionType === 'multiple_select') {
                // Multiple select: answers are comma-separated
                answer.split(',').forEach(option => {
                    const input = card.querySelector(`input[value="${option}"]`);
                    if (input) input.checked = true;
                });
            } else {
                // Single answer
                const input = card.querySelector(`input[value="${answer}"]`);
                if (input) input.checked = true;
            }
        });
    }
});

// Form submission handling - UPDATED FOR AJAX
document.getElementById('quizForm').addEventListener('submit', function(e) {
    e.preventDefault(); // Prevent traditional form submission
    
    // Clear draft on submit
    localStorage.removeItem('quiz_draft_{{ quiz.id }}');
    
    // Disable submit button to prevent double submission
    const submitBtn = this.querySelector('button[type="submit"]');
    const originalBtnText = submitBtn.innerHTML;
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Submitting...';
    
    // If timer exists, stop it
    if (timerInterval) {
        clearInterval(timerInterval);
    }
    
    // Collect form data
    const formData = new FormData(this);
    
    // Send AJAX request
    fetch(this.action, {
        method: 'POST',
        body: formData,
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Show success message
            submitBtn.innerHTML = '<i class="fas fa-check me-2"></i>Submitted!';
            submitBtn.classList.remove('btn-success');
            submitBtn.classList.add('btn-primary');
            
            // Redirect to results page after a short delay
            setTimeout(() => {
                window.location.href = data.redirect_url;
            }, 1500);
        } else {
            // Show error
            alert('Error: ' + data.error);
            submitBtn.disabled = false;
            submitBtn.innerHTML = originalBtnText;
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('An error occurred. Please try again.');
        submitBtn.disabled = false;
        submitBtn.innerHTML = originalBtnText;
    });
});
</script>

<style>
.bg-grey {
    background-color: #f8f9fa !important;
    border-color: #dee2e6 !important;
}

.card.border-dark {
    border-color: #343a40 !important;
}

.card.border-grey {
    border-color: #dee2e6 !important;
}

.card-header.bg-dark {
    background-color: #343a40 !important;
    border-bottom-color: #454d55 !important;
}

.card-header.bg-grey {
    background-color: #e9ecef !important;
    border-bottom-color: #dee2e6 !important;
}

/* Question styling */
.question-card {
    transition: all 0.2s ease;
}

.question-card:hover {
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
}

.form-check-input:checked {
    background-color: #198754;
    border-color: #198754;
}

/* Timer styling */
#timerDisplay {
    font-family: monospace;
    font-weight: bold;
    font-size: 1.2rem;
}
</style>
{% endblock %}